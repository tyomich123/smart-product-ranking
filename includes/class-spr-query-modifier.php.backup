<?php
/**
 * Клас для модифікації WooCommerce запитів
 */

if (!defined('ABSPATH')) {
    exit;
}

class SPR_Query_Modifier {
    
    private static $instance = null;
    private $ranking_engine;
    
    public static function get_instance() {
        if (null === self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    private function __construct() {
        $this->ranking_engine = SPR_Ranking_Engine::get_instance();
        
        // Модифікація запитів WooCommerce
        add_filter('woocommerce_product_query', array($this, 'modify_product_query'), 10, 2);
        
        // Модифікація сортування
        add_filter('posts_clauses', array($this, 'modify_query_clauses'), 10, 2);
        
        // Додавання нового варіанту сортування
        add_filter('woocommerce_catalog_orderby', array($this, 'add_relevance_sorting'));
        add_filter('woocommerce_get_catalog_ordering_args', array($this, 'get_relevance_sorting_args'));
        
        // Додавання мета-даних для сортування
        add_action('pre_get_posts', array($this, 'pre_get_posts_sorting'));
    }
    
    /**
     * Модифікація запиту продуктів
     */
    public function modify_product_query($q, $query) {
        // Перевіряємо чи це запит категорії (НЕ головна сторінка)
        if (!is_admin() && $q->is_main_query() && is_product_category()) {
            // Встановлюємо мета-запит для включення скору релевантності
            $q->set('update_post_meta_cache', true);
        }
        
        return $q;
    }
    
    /**
     * Модифікація SQL запиту для сортування за релевантністю
     */
    public function modify_query_clauses($clauses, $query) {
        global $wpdb;
        
        // КРИТИЧНО: Перевіряємо чи це ТІЛЬКИ категорія товарів
        // НЕ втручаємось на головній, в пошуку, тегах, тощо
        if (!is_admin() && 
            $query->is_main_query() && 
            is_product_category()) {
            
            // Додаткова перевірка: чи це запит товарів
            $post_type = $query->get('post_type');
            if ($post_type && $post_type !== 'product') {
                return $clauses;
            }
            
            // Отримуємо налаштування
            $settings = get_option('spr_settings', array());
            $use_as_default = isset($settings['use_as_default_sorting']) ? $settings['use_as_default_sorting'] : true;
            
            // Перевіряємо чи користувач вибрав інше сортування
            $orderby = isset($query->query_vars['orderby']) ? $query->query_vars['orderby'] : '';
            
            // Якщо налаштування вимкнене і не вибрано 'relevance' - не втручаємось
            if (!$use_as_default && $orderby !== 'relevance') {
                return $clauses;
            }
            
            // Якщо вибрано конкретне сортування (ціна, назва) - не втручаємось
            $custom_sorting = array('price', 'price-desc', 'popularity', 'rating', 'date');
            if (!empty($orderby) && in_array($orderby, $custom_sorting)) {
                return $clauses;
            }
            
            // Отримуємо ID категорії
            $queried_object = get_queried_object();
            if (!$queried_object || !isset($queried_object->term_id)) {
                return $clauses;
            }
            
            $category_id = $queried_object->term_id;
            
            if ($category_id > 0) {
                $relevance_table = $wpdb->prefix . 'spr_product_relevance';
                $views_table = $wpdb->prefix . 'spr_product_views';
                
                // Отримуємо всі налаштування один раз
                $enable_personalization = isset($settings['enable_personalization']) ? $settings['enable_personalization'] : true;
                $show_unranked = isset($settings['show_unranked_products']) ? $settings['show_unranked_products'] : true;
                
                // Додаємо JOIN до таблиці релевантності
                $clauses['join'] .= " LEFT JOIN {$relevance_table} AS spr ON {$wpdb->posts}.ID = spr.product_id AND spr.category_id = {$category_id}";
                
                // Якщо персоналізація увімкнена, додаємо JOIN до таблиці переглядів
                if ($enable_personalization) {
                    $tracker = SPR_Tracker::get_instance();
                    $user_identifier = $tracker->get_user_identifier();
                    
                    if ($user_identifier) {
                        if ($user_identifier['type'] === 'user') {
                            $clauses['join'] .= $wpdb->prepare(
                                " LEFT JOIN (
                                    SELECT product_id, COUNT(*) as user_view_count 
                                    FROM {$views_table} 
                                    WHERE user_id = %d 
                                    AND view_date > DATE_SUB(NOW(), INTERVAL 30 DAY)
                                    GROUP BY product_id
                                ) AS spr_user_views ON {$wpdb->posts}.ID = spr_user_views.product_id",
                                $user_identifier['id']
                            );
                        } else {
                            $clauses['join'] .= $wpdb->prepare(
                                " LEFT JOIN (
                                    SELECT product_id, COUNT(*) as user_view_count 
                                    FROM {$views_table} 
                                    WHERE session_id = %s 
                                    AND view_date > DATE_SUB(NOW(), INTERVAL 30 DAY)
                                    GROUP BY product_id
                                ) AS spr_user_views ON {$wpdb->posts}.ID = spr_user_views.product_id",
                                $user_identifier['id']
                            );
                        }
                        
                        // Модифікуємо ORDER BY з урахуванням персоналізації
                        $order = isset($query->query_vars['order']) ? $query->query_vars['order'] : 'DESC';
                        
                        // Формула: базовий скор + бонус за перегляди користувача
                        if ($show_unranked) {
                            // Показуємо всі товари: спочатку з скором, потім без скору за датою
                            $clauses['orderby'] = "
                                CASE 
                                    WHEN spr.relevance_score IS NOT NULL THEN 1 
                                    ELSE 2 
                                END ASC,
                                (COALESCE(spr.relevance_score, 0) + 
                                CASE 
                                    WHEN spr_user_views.user_view_count IS NOT NULL THEN 
                                        LEAST(5 + (spr_user_views.user_view_count * 3), 15)
                                    ELSE 0 
                                END) {$order}, 
                                {$wpdb->posts}.post_date DESC";
                        } else {
                            // Показуємо тільки товари зі скором
                            $clauses['where'] .= " AND spr.relevance_score IS NOT NULL";
                            $clauses['orderby'] = "
                                (COALESCE(spr.relevance_score, 0) + 
                                CASE 
                                    WHEN spr_user_views.user_view_count IS NOT NULL THEN 
                                        LEAST(5 + (spr_user_views.user_view_count * 3), 15)
                                    ELSE 0 
                                END) {$order}, 
                                {$wpdb->posts}.post_date DESC";
                        }
                    } else {
                        // Персоналізація увімкнена, але користувач не ідентифікований
                        $order = isset($query->query_vars['order']) ? $query->query_vars['order'] : 'DESC';
                        
                        if ($show_unranked) {
                            $clauses['orderby'] = "
                                CASE 
                                    WHEN spr.relevance_score IS NOT NULL THEN 1 
                                    ELSE 2 
                                END ASC,
                                COALESCE(spr.relevance_score, 0) {$order}, 
                                {$wpdb->posts}.post_date DESC";
                        } else {
                            $clauses['where'] .= " AND spr.relevance_score IS NOT NULL";
                            $clauses['orderby'] = "COALESCE(spr.relevance_score, 0) {$order}, {$wpdb->posts}.post_date DESC";
                        }
                    }
                } else {
                    // Персоналізація вимкнена - використовуємо тільки базовий скор
                    $order = isset($query->query_vars['order']) ? $query->query_vars['order'] : 'DESC';
                    
                    if ($show_unranked) {
                        $clauses['orderby'] = "
                            CASE 
                                WHEN spr.relevance_score IS NOT NULL THEN 1 
                                ELSE 2 
                            END ASC,
                            COALESCE(spr.relevance_score, 0) {$order}, 
                            {$wpdb->posts}.post_date DESC";
                    } else {
                        $clauses['where'] .= " AND spr.relevance_score IS NOT NULL";
                        $clauses['orderby'] = "COALESCE(spr.relevance_score, 0) {$order}, {$wpdb->posts}.post_date DESC";
                    }
                }
                
                // Додаємо DISTINCT щоб уникнути дублікатів
                $clauses['distinct'] = 'DISTINCT';
            }
        }
        
        return $clauses;
    }
    
    /**
     * Додавання сортування за релевантністю в WooCommerce
     */
    public function add_relevance_sorting($sortby) {
        $sortby['relevance'] = __('За релевантністю', 'smart-product-ranking');
        return $sortby;
    }
    
    /**
     * Аргументи для сортування за релевантністю
     */
    public function get_relevance_sorting_args($args) {
        if (isset($_GET['orderby']) && $_GET['orderby'] === 'relevance') {
            $args['orderby'] = 'relevance';
            $args['order'] = 'DESC';
        }
        
        return $args;
    }
    
    /**
     * Налаштування сортування в pre_get_posts
     */
    public function pre_get_posts_sorting($query) {
        if (!is_admin() && 
            $query->is_main_query() && 
            is_product_category()) {
            
            // Перевіряємо налаштування
            $settings = get_option('spr_settings', array());
            $use_as_default = isset($settings['use_as_default_sorting']) ? $settings['use_as_default_sorting'] : true;
            
            // Якщо налаштування вимкнене - не втручаємось
            if (!$use_as_default) {
                return;
            }
            
            // Якщо не вказано сортування, використовуємо релевантність
            if (!isset($_GET['orderby']) || empty($_GET['orderby'])) {
                $query->set('orderby', 'relevance');
                $query->set('order', 'DESC');
            }
        }
    }
    
    /**
     * Додавання скору релевантності до продукту (для використання в шаблонах)
     */
    public function get_product_relevance_display($product_id) {
        $category_id = 0;
        
        if (is_product_category()) {
            $queried_object = get_queried_object();
            if ($queried_object) {
                $category_id = $queried_object->term_id;
            }
        }
        
        if ($category_id > 0) {
            $score = $this->ranking_engine->get_cached_relevance_score($product_id, $category_id);
            return round($score, 2);
        }
        
        return 0;
    }
    
    /**
     * Шорткод для відображення скору релевантності
     */
    public function relevance_score_shortcode($atts) {
        global $product;
        
        if (!$product) {
            return '';
        }
        
        $atts = shortcode_atts(array(
            'show_label' => 'yes'
        ), $atts);
        
        $score = $this->get_product_relevance_display($product->get_id());
        
        if ($score > 0) {
            $output = '<div class="spr-relevance-score">';
            
            if ($atts['show_label'] === 'yes') {
                $output .= '<span class="spr-label">' . __('Релевантність:', 'smart-product-ranking') . ' </span>';
            }
            
            $output .= '<span class="spr-score">' . $score . '%</span>';
            $output .= '</div>';
            
            return $output;
        }
        
        return '';
    }
}

// Реєстрація шорткоду
add_shortcode('product_relevance', array(SPR_Query_Modifier::get_instance(), 'relevance_score_shortcode'));

/**
 * Хелпер-функція для отримання скору релевантності
 */
function spr_get_product_relevance($product_id = null) {
    if (!$product_id) {
        global $product;
        if ($product) {
            $product_id = $product->get_id();
        }
    }
    
    if (!$product_id) {
        return 0;
    }
    
    $modifier = SPR_Query_Modifier::get_instance();
    return $modifier->get_product_relevance_display($product_id);
}
